<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢è²ç´‹è¾¨è­˜å™¨ V3.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pokedex-red: #dc0a2d;
            --pokedex-dark-red: #8b0000;
            --screen-bg: #222;
            --ui-blue: #2196F3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .pokedex-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--pokedex-red);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Top Sensor Bar */
        .top-bar {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 5px solid var(--pokedex-dark-red);
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .camera-lens {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #44d4ff, #005a9e);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-right: 15px;
        }

        .indicators { display: flex; gap: 10px; }
        .led { width: 15px; height: 15px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
        .led.red { background-color: #ff5555; }
        .led.yellow { background-color: #ffcc00; }
        .led.green { background-color: #55ff55; }

        /* Main Screen Area */
        .screen-container {
            background-color: #dedede;
            margin: 20px;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 85% 100%, 0 100%);
            border: 2px solid #555;
            display: flex;
            flex-direction: column;
        }

        .screen {
            background-color: var(--screen-bg);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            min-height: 300px;
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            width: 100%;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #666;
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .tab-btn.active { color: #0f0; border-bottom: 2px solid #0f0; }

        /* Content Sections */
        .section { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .section.active { display: flex; }

        h2 { margin: 0; color: #0f0; font-size: 1rem; border-bottom: 1px solid #0f0; width: 100%; text-align: center; padding-bottom: 5px; font-family: 'Courier New', monospace; }

        /* Controls */
        .control-panel {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background-color: var(--pokedex-red);
            margin-top: auto;
        }

        .btn {
            border: none;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-record { background-color: #2196F3; }
        .btn-stop { background-color: #f44336; }
        .btn:disabled { background-color: #777; cursor: not-allowed; opacity: 0.7; }

        /* Visualizer */
        canvas { width: 100%; height: 60px; background-color: #000; border: 1px solid #0f0; margin-bottom: 10px; flex-shrink: 0; }

        /* Image Display */
        .pokemon-display {
            width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center;
            background-color: rgba(0, 50, 0, 0.5); border-radius: 5px; margin: 10px 0; border: 1px dashed #0f0; position: relative;
        }
        .pokemon-display img { max-width: 100%; max-height: 180px; object-fit: contain; display: none; z-index: 1; }
        .placeholder-icon { color: #0f0; font-size: 4rem; opacity: 0.5; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 0.7; } 100% { opacity: 0.3; } }

        /* Result Box */
        .result-box { background-color: #000; padding: 10px; width: 95%; text-align: center; border: 1px solid #0f0; margin-top: auto; color: #0f0; font-family: 'Courier New', monospace; }
        .result-name { font-size: 1.5rem; font-weight: bold; color: #fff; margin: 5px 0; }
        
        /* Gallery Grid */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;
            overflow-y: auto; max-height: 280px; padding-top: 10px;
        }
        .gallery-item {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
        }
        .gallery-item:hover { border-color: #0f0; background: rgba(0, 255, 0, 0.1); }
        .gallery-thumb { width: 50px; height: 50px; object-fit: contain; }
        .gallery-name { font-size: 0.7rem; color: #0f0; margin-top: 5px; text-align: center; }
        .gallery-play { font-size: 0.8rem; color: #fff; margin-top: 2px; }

        /* Loading Overlay */
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 20; color: #0f0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Courier New', monospace; text-align: center;
        }
        .start-btn { margin-top: 20px; padding: 10px 20px; background: #0f0; color: #000; border: none; font-weight: bold; cursor: pointer; display: none;}
    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="top-bar">
        <div class="camera-lens"></div>
        <div class="indicators">
            <div class="led red"></div>
            <div class="led yellow"></div>
            <div class="led green"></div>
        </div>
    </div>

    <div class="screen-container">
        <div class="screen">
            <div id="loadingOverlay">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <div id="loadingText" style="margin-top: 10px">è®€å–ç³»çµ±ä¸­...</div>
                <button id="startSystemBtn" class="start-btn" onclick="startSystem()">
                    <i class="fas fa-power-off"></i> å•Ÿå‹•è²ç´‹ç³»çµ±
                </button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scan')">è¾¨è­˜æ¨¡å¼</button>
                <button class="tab-btn" onclick="switchTab('gallery')">è³‡æ–™åº«åœ–é‘‘</button>
            </div>

            <div id="scanSection" class="section active">
                <canvas id="visualizer"></canvas>
                <div class="pokemon-display">
                    <i class="fas fa-wave-square placeholder-icon" id="placeholderIcon"></i>
                    <img id="pokemonImg" src="" alt="Pokemon">
                </div>
                <div class="result-box">
                    <div class="result-name" id="matchName">---</div>
                    <div class="result-score" id="matchScore">è«‹æŒ‰ä¸‹éŒ„éŸ³</div>
                </div>
            </div>

            <div id="gallerySection" class="section">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">é»æ“Šä»¥è©¦è½æ¨£æœ¬</div>
                <div class="gallery-grid" id="galleryGrid">
                    </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-record" id="btnRecord" disabled onclick="startRecording()">
            <i class="fas fa-microphone-lines fa-lg"></i><br>é•·æŒ‰éŒ„éŸ³
        </button>
        <button class="btn btn-stop" id="btnStop" disabled onclick="stopRecording()">
            <i class="fas fa-stop-circle fa-lg"></i><br>æ”¾é–‹åœæ­¢
        </button>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šèˆ‡åƒæ•¸
    // ==========================================
    const AUDIO_EXT = '.opus'; // æ”¯æ´ .opus, .mp3, .wav
    const IMAGE_EXT = '.png';
    const MEL_BANDS = 40; // å°‡é »è­œåˆ†ç‚º 40 å€‹æ„ŸçŸ¥é »æ®µ (æ¯”å°æ›´æº–)
    const SILENCE_THRESH = 0.05; // éœéŸ³éæ¿¾é–€æª» (0.0 ~ 1.0)
    
    // ==========================================
    // ğŸš€ æ ¸å¿ƒè®Šæ•¸
    // ==========================================
    let audioContext;
    let database = []; // {name, buffer, feature}
    let mediaRecorder;
    let audioChunks = [];
    let analyser;
    let dataArray;
    let animationId;
    let isSystemStarted = false;

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const startSystemBtn = document.getElementById('startSystemBtn');
    const btnRecord = document.getElementById('btnRecord');
    const btnStop = document.getElementById('btnStop');
    const galleryGrid = document.getElementById('galleryGrid');
    
    // --- 1. è‡ªå‹•è¼‰å…¥ (Page Load) ---
    document.addEventListener('DOMContentLoaded', async () => {
        await loadListAndAssets();
    });

    async function loadListAndAssets() {
        try {
            // A. è®€å– list.txt
            const response = await fetch('list.txt?nocache=' + Date.now());
            if (!response.ok) throw new Error("æ‰¾ä¸åˆ° list.txt");
            const text = await response.text();
            const list = text.split(/\r?\n/).filter(line => line.trim() !== "");

            // B. å»ºç«‹é è¦½ä»‹é¢ (é‚„ä¸èƒ½è§£ç¢¼è²éŸ³ï¼Œå› ç‚º AudioContext æœªå•Ÿå‹•)
            database = list.map(name => ({ 
                name: name.trim(), 
                buffer: null, 
                feature: null 
            }));
            
            renderGallery();
            
            loadingText.innerHTML = `å·²è®€å– ${list.length} ç­†è³‡æ–™<br>è«‹é»æ“Šå•Ÿå‹•`;
            document.querySelector('.fa-spinner').style.display = 'none';
            startSystemBtn.style.display = 'inline-block';

        } catch (err) {
            loadingText.innerText = "âŒ è¼‰å…¥å¤±æ•—: " + err.message;
        }
    }

    // --- 2. å•Ÿå‹•ç³»çµ± (User Click) ---
    async function startSystem() {
        startSystemBtn.disabled = true;
        loadingText.innerText = "æ­£åœ¨åˆ†æè²ç´‹ç‰¹å¾µ...";
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // ä¸‹è¼‰ä¸¦è§£ç¢¼æ‰€æœ‰éŸ³è¨Š
            let loadedCount = 0;
            for (let item of database) {
                try {
                    const res = await fetch(`wav/${item.name}${AUDIO_EXT}`);
                    if(res.ok) {
                        const buf = await res.arrayBuffer();
                        item.buffer = await audioContext.decodeAudioData(buf);
                        // ğŸ”¥ é å…ˆè¨ˆç®—ç‰¹å¾µ
                        item.feature = await extractMelFeature(item.buffer);
                        loadedCount++;
                    }
                } catch (e) { console.error(e); }
            }

            // å®Œæˆ
            loadingOverlay.style.display = 'none';
            btnRecord.disabled = false;
            isSystemStarted = true;

        } catch (err) {
            alert("ç³»çµ±å•Ÿå‹•å¤±æ•—: " + err);
        }
    }

    // --- 3. æ¼”ç®—æ³•å‡ç´šï¼šéœéŸ³åˆ‡é™¤ + Mel é »æ®µç‰¹å¾µ ---
    
    // A. éœéŸ³åˆ‡é™¤ (Trim Silence)
    function trimSilence(buffer) {
        const raw = buffer.getChannelData(0);
        const len = raw.length;
        let start = 0;
        let end = len - 1;

        // å°‹æ‰¾é–‹é ­ (RMS èƒ½é‡å¤§æ–¼é–€æª»)
        while (start < len && Math.abs(raw[start]) < SILENCE_THRESH) start++;
        // å°‹æ‰¾çµå°¾
        while (end > start && Math.abs(raw[end]) < SILENCE_THRESH) end--;

        if (start >= end) return buffer; // å…¨æ˜¯éœéŸ³ï¼Œç›´æ¥å›å‚³

        const newLen = end - start + 1;
        const newCtx = new OfflineAudioContext(1, newLen, buffer.sampleRate);
        const newBuffer = newCtx.createBuffer(1, newLen, buffer.sampleRate);
        newBuffer.copyToChannel(raw.slice(start, end + 1), 0);
        return newBuffer;
    }

    // B. æå–ç‰¹å¾µ (Mel-Like Bands)
    async function extractMelFeature(audioBuffer) {
        // å…ˆåˆ‡é™¤éœéŸ³
        const trimmedBuffer = trimSilence(audioBuffer);
        
        // é›¢ç·šåˆ†æ
        const offlineCtx = new OfflineAudioContext(1, trimmedBuffer.length, trimmedBuffer.sampleRate);
        const source = offlineCtx.createBufferSource();
        source.buffer = trimmedBuffer;

        const fftSize = 1024;
        const analyserNode = offlineCtx.createAnalyser();
        analyserNode.fftSize = fftSize;
        analyserNode.smoothingTimeConstant = 0.0;

        source.connect(analyserNode);
        analyserNode.connect(offlineCtx.destination);
        source.start(0);

        // æ¡æ¨£èˆ‡è¨ˆç®—
        const duration = trimmedBuffer.duration;
        // æˆ‘å€‘å–å›ºå®šæ•¸é‡çš„æ¡æ¨£é» (ä¾‹å¦‚ 50 å€‹æ™‚é–“åˆ‡ç‰‡)ï¼Œç„¶å¾Œå¹³å‡
        const steps = 50; 
        const interval = duration / steps;
        
        let melAccumulator = new Float32Array(MEL_BANDS).fill(0);
        let count = 0;

        // å»ºç«‹é »ç‡å°æ‡‰è¡¨ (Log scale mapping)
        // å°‡ 0 ~ 512 (FFT bins) æ˜ å°„åˆ° 0 ~ 40 (Mel bands)
        const binMap = [];
        for(let i=0; i<fftSize/2; i++) {
             // ç°¡å–®çš„ Log æ˜ å°„æ¨¡æ“¬ Mel Scale
             const normalizedFreq = i / (fftSize/2); 
             const melIndex = Math.floor(Math.log1p(normalizedFreq * 100) / Math.log1p(100) * MEL_BANDS);
             binMap.push(Math.min(melIndex, MEL_BANDS - 1));
        }

        // æ¨¡æ“¬æ’­æ”¾éç¨‹å–æ¨£
        for (let i = 0; i < steps; i++) {
            const time = i * interval;
            offlineCtx.suspend(time).then(() => {
                const tempArray = new Uint8Array(analyserNode.frequencyBinCount);
                analyserNode.getByteFrequencyData(tempArray);
                
                // å°‡ FFT Bin çš„èƒ½é‡ç´¯åŠ åˆ° Mel Band
                for (let j = 0; j < tempArray.length; j++) {
                    melAccumulator[binMap[j]] += tempArray[j];
                }
                count++;
            }).then(() => offlineCtx.resume());
        }

        await offlineCtx.startRendering();

        // å¹³å‡åŒ–èˆ‡æ­¸ä¸€åŒ–
        for(let i=0; i<MEL_BANDS; i++) {
            if(count > 0) melAccumulator[i] /= count;
        }
        return normalizeVector(melAccumulator);
    }

    // --- 4. ä»‹é¢æ“ä½œï¼šåœ–é‘‘èˆ‡åˆ‡æ› ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        if (mode === 'scan') {
            document.querySelector("button[onclick=\"switchTab('scan')\"]").classList.add('active');
            document.getElementById('scanSection').classList.add('active');
        } else {
            document.querySelector("button[onclick=\"switchTab('gallery')\"]").classList.add('active');
            document.getElementById('gallerySection').classList.add('active');
        }
    }

    function renderGallery() {
        galleryGrid.innerHTML = '';
        database.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `
                <img src="pic/${item.name}${IMAGE_EXT}" class="gallery-thumb" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwZmYwMCIgZD0iTTEyIDJDMiAyIDIgMTIgMiAxMnMyIDEwIDEwIDEwIDEwLTEwIDEwLTEwUzIyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4IDh6Ii8+PC9zdmc+'">
                <div class="gallery-name">${item.name}</div>
                <div class="gallery-play"><i class="fas fa-play"></i></div>
            `;
            div.onclick = () => playSample(item);
            galleryGrid.appendChild(div);
        });
    }

    function playSample(item) {
        if (!isSystemStarted) {
            alert("è«‹å…ˆé»æ“Šé¦–é çš„ã€Œå•Ÿå‹•è²ç´‹ç³»çµ±ã€");
            return;
        }
        if (!item.buffer) {
            alert("éŸ³æª”å°šæœªè¼‰å…¥æˆ–è®€å–å¤±æ•—");
            return;
        }
        // æ’­æ”¾è²éŸ³
        const source = audioContext.createBufferSource();
        source.buffer = item.buffer;
        source.connect(audioContext.destination);
        source.start(0);
    }

    // --- 5. éŒ„éŸ³æ§åˆ¶ (é‚è¼¯ä¸è®Šï¼Œåƒ…å‘¼å«æ–°æ¼”ç®—æ³•) ---
    async function startRecording() {
        // åˆ‡æ›å›è¾¨è­˜åˆ†é 
        switchTab('scan');
        document.getElementById('matchName').innerText = "è†è½ä¸­...";
        document.getElementById('matchScore').innerText = "...";
        document.getElementById('pokemonImg').style.display = 'none';
        document.getElementById('placeholderIcon').style.display = 'block';

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            // è¦–è¦ºåŒ–
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animationId);
                stream.getTracks().forEach(track => track.stop());
                
                const blob = new Blob(audioChunks, { type: 'audio/webm' }); // Chrome/Android
                const buf = await audioContext.decodeAudioData(await blob.arrayBuffer());
                
                compareSound(buf);
            };

            mediaRecorder.start();
            btnRecord.disabled = true;
            btnStop.disabled = false;

        } catch (err) { alert("éº¥å…‹é¢¨éŒ¯èª¤: " + err); }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            btnRecord.disabled = false;
            btnStop.disabled = true;
        }
    }

    // --- 6. æ¯”å°æ ¸å¿ƒ ---
    async function compareSound(recordedBuffer) {
        if(database.length === 0 || !database[0].feature) {
            alert("è³‡æ–™åº«å°šæœªå°±ç·’"); return;
        }

        document.getElementById('matchName').innerText = "åˆ†æé‹ç®—ä¸­...";
        
        // æå–éŒ„éŸ³ç‰¹å¾µ (åŒæ¨£ç¶“é Silence Trim + Mel)
        const recordedFeature = await extractMelFeature(recordedBuffer);

        let bestMatch = null;
        let bestScore = -1;

        for (let item of database) {
            if(!item.feature) continue;
            const score = cosineSimilarity(recordedFeature, item.feature);
            if (score > bestScore) {
                bestScore = score;
                bestMatch = item.name;
            }
        }

        // é¡¯ç¤ºçµæœ
        const scorePct = (bestScore * 100).toFixed(1);
        const img = document.getElementById('pokemonImg');
        const icon = document.getElementById('placeholderIcon');
        const nameEl = document.getElementById('matchName');
        const scoreEl = document.getElementById('matchScore');

        // é¡¯ç¤ºåœ–ç‰‡
        img.src = `pic/${bestMatch}${IMAGE_EXT}`;
        img.onload = () => { img.style.display='block'; icon.style.display='none'; };
        img.onerror = () => { img.style.display='none'; icon.style.display='block'; };

        // åˆ¤æ–·ä¿¡å¿ƒåº¦ (å› ç‚ºä½¿ç”¨ Mel Bandï¼Œç‰¹å¾µè¼ƒæ¨¡ç³Šï¼Œåˆ†æ•¸é€šå¸¸æœƒæ¯”è¼ƒé«˜ï¼Œé–€æª»è¦æ‹‰é«˜)
        const THRESHOLD = 0.92; 
        
        if (bestScore > THRESHOLD) {
            nameEl.innerText = bestMatch;
            nameEl.style.color = "#0f0";
            scoreEl.innerText = `ç›¸ä¼¼åº¦: ${scorePct}% (æ¥µé«˜)`;
        } else if (bestScore > 0.80) {
            nameEl.innerText = `${bestMatch}?`;
            nameEl.style.color = "#ffeb3b";
            scoreEl.innerText = `ç›¸ä¼¼åº¦: ${scorePct}% (ç–‘ä¼¼)`;
        } else {
            nameEl.innerText = "ç„¡æ³•è¾¨è­˜";
            nameEl.style.color = "#888";
            scoreEl.innerText = `ç›¸ä¼¼åº¦: ${scorePct}% (éä½)`;
            img.style.display='none'; icon.style.display='block';
        }
    }

    // æ•¸å­¸å·¥å…·
    function normalizeVector(vec) {
        let sumSq = 0;
        for(let v of vec) sumSq += v*v;
        const mag = Math.sqrt(sumSq);
        return vec.map(v => mag===0 ? 0 : v/mag);
    }
    function cosineSimilarity(a, b) {
        let dot = 0;
        for(let i=0; i<a.length; i++) dot += a[i]*b[i];
        return dot;
    }

    // è¦–è¦ºåŒ–
    function drawVisualizer() {
        animationId = requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);
        const ctx = document.getElementById('visualizer').getContext('2d');
        const w = ctx.canvas.width;
        const h = ctx.canvas.height;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
        const barW = (w / dataArray.length) * 2.5;
        let x = 0;
        for(let i=0; i<dataArray.length; i++) {
            const barH = (dataArray[i]/255)*h;
            ctx.fillStyle = `rgb(0, ${dataArray[i]+50}, 0)`;
            ctx.fillRect(x, h-barH, barW, barH);
            x += barW + 1;
        }
    }
</script>
</body>
</html>