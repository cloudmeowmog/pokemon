<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¯¶å¯å¤¢è²ç´‹è¾¨è­˜å™¨ (æœ€çµ‚ç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pokedex-red: #dc0a2d;
            --pokedex-dark-red: #8b0000;
            --screen-bg: #1a1a1a; 
            --ui-blue: #2196F3;
        }

        /* 1. iOS Safari æ»¿ç‰ˆä¿®æ­£æ ¸å¿ƒ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            /* ä½¿ç”¨ dvh (Dynamic Viewport Height) è‡ªå‹•æ‰£é™¤ç€è¦½å™¨å·¥å…·åˆ—é«˜åº¦ */
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden;
        }

        .pokedex-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--pokedex-red);
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* é ‚éƒ¨æ„Ÿæ‡‰å™¨å€ */
        .top-bar {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 5px solid var(--pokedex-dark-red);
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            z-index: 10;
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
        }

        .camera-lens {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #44d4ff, #005a9e);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-right: 15px;
        }

        .indicators { display: flex; gap: 10px; }
        .led { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
        .led.red { background-color: #ff5555; }
        .led.yellow { background-color: #ffcc00; }
        .led.green { background-color: #55ff55; }

        /* ä¸»è¢å¹•å€å¡Š */
        .screen-container {
            background-color: #dedede;
            margin: 15px;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            clip-path: polygon(0 0, 100% 0, 100% 95%, 90% 100%, 0 100%); /* ä¿®æ­£åˆ‡è§’ */
            border: 2px solid #555;
            flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen {
            background-color: var(--screen-bg);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        /* åˆ†é æŒ‰éˆ• */
        .tab-buttons {
            display: flex;
            width: 100%;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #666;
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .tab-btn.active { color: #0f0; border-bottom: 2px solid #0f0; background: rgba(0,255,0,0.05); }

        /* å…§å®¹å€å¡Š */
        .section { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .section.active { display: flex; }

        /* è¦–è¦ºåŒ–èˆ‡çµæœ */
        canvas { width: 100%; height: 60px; background-color: #000; border: 1px solid #0f0; margin-bottom: 10px; flex-shrink: 0; border-radius: 4px;}
        
        .pokemon-display {
            width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center;
            background-color: rgba(0, 50, 0, 0.3); border-radius: 5px; margin: 5px 0; border: 1px dashed #0f0; position: relative;
            min-height: 150px;
        }
        .pokemon-display img { max-width: 90%; max-height: 200px; object-fit: contain; display: none; z-index: 2; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        
        .placeholder-icon { color: #0f0; font-size: 4rem; opacity: 0.3; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.6; } 100% { opacity: 0.2; } }

        .result-box {
            background-color: rgba(0,0,0,0.8); padding: 8px; width: 95%; text-align: center; border: 1px solid #0f0; 
            margin-top: auto; color: #0f0; font-family: 'Courier New', monospace; border-radius: 4px;
        }
        .result-name { font-size: 1.4rem; font-weight: bold; color: #fff; margin: 2px 0; text-shadow: 0 0 5px #0f0;}
        .result-score { font-size: 0.8rem; color: #aaa; }

        /* è³‡æ–™åº«åœ–é‘‘ */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%;
            overflow-y: auto; padding-bottom: 20px; 
        }
        .gallery-item {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.05); padding: 5px; border-radius: 5px; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
        }
        .gallery-item:hover { border-color: #0f0; background: rgba(0, 255, 0, 0.1); }
        .gallery-item img { width: 40px; height: 40px; object-fit: contain; }
        .gallery-name { font-size: 0.7rem; color: #aaa; margin-top: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;}

        /* æ§åˆ¶é¢æ¿ (ä¿®æ­£æŒ‰éˆ•è¢«é®æ“‹å•é¡Œ) */
        .control-panel {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background-color: var(--pokedex-red);
            flex-shrink: 0;
            
            /* 2. iOS åº•éƒ¨å®‰å…¨è·é›¢ä¿®æ­£ */
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .btn {
            border: none;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-record { background-color: #2196F3; }
        .btn-stop { background-color: #f44336; }
        .btn:disabled { background-color: #777; cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none;}

        /* Loading Overlay */
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 20; color: #0f0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Courier New', monospace; text-align: center;
        }
        .start-btn { margin-top: 20px; padding: 10px 25px; background: #0f0; color: #000; border: none; border-radius:50px; font-weight: bold; font-size:1.1rem; cursor: pointer; display: none; box-shadow: 0 0 15px #0f0;}
    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="top-bar">
        <div class="camera-lens"></div>
        <div class="indicators">
            <div class="led red"></div>
            <div class="led yellow"></div>
            <div class="led green"></div>
        </div>
    </div>

    <div class="screen-container">
        <div class="screen">
            <div id="loadingOverlay">
                <i class="fas fa-satellite-dish fa-spin fa-2x" style="margin-bottom:15px"></i>
                <div id="loadingText">åˆå§‹åŒ–ç³»çµ±...</div>
                <button id="startSystemBtn" class="start-btn" onclick="startSystem()">
                    <i class="fas fa-power-off"></i> å•Ÿå‹•ç³»çµ±
                </button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scan')">è²ç´‹æ¯”å°</button>
                <button class="tab-btn" onclick="switchTab('gallery')">è³‡æ–™åº«åœ–é‘‘</button>
            </div>

            <div id="scanSection" class="section active">
                <canvas id="visualizer"></canvas>
                <div class="pokemon-display">
                    <i class="fas fa-fingerprint placeholder-icon" id="placeholderIcon"></i>
                    <img id="pokemonImg" src="" alt="Pokemon">
                </div>
                <div class="result-box">
                    <div class="result-name" id="matchName">---</div>
                    <div class="result-score" id="matchScore">è«‹æŒ‰ä¸‹éŒ„éŸ³</div>
                </div>
            </div>

            <div id="gallerySection" class="section">
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-record" id="btnRecord" disabled onclick="startRecording()">
            <i class="fas fa-microphone fa-lg"></i><br>éŒ„éŸ³
        </button>
        <button class="btn btn-stop" id="btnStop" disabled onclick="stopRecording()">
            <i class="fas fa-stop fa-lg"></i><br>åœæ­¢
        </button>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ V4.0 è¨­å®šåƒæ•¸
    // ==========================================
    const CONFIG = {
        audioExt: '.opus',    // è²éŸ³æª”æ ¼å¼
        imgExt: '.png',      // åœ–ç‰‡æª”æ ¼å¼
        fftSize: 1024,       // è§£æåº¦
        timeSlices: 30,      // æ™‚é–“åˆ‡ç‰‡æ•¸é‡ (åœ–åƒåŒ–å¯¬åº¦)
        freqBands: 32,       // é »ç‡å€é–“æ•¸é‡ (åœ–åƒåŒ–é«˜åº¦)
        silenceThresh: 0.02, // éœéŸ³éæ¿¾é–€æª»
        minDuration: 0.2     // æœ€å°æœ‰æ•ˆç§’æ•¸
    };

    // ==========================================
    // ğŸš€ å…¨åŸŸè®Šæ•¸
    // ==========================================
    let audioContext;
    let database = []; // {name, buffer, signature}
    let mediaRecorder;
    let audioChunks = [];
    let analyser;
    let dataArray;
    let animationId;
    let isSystemStarted = false;

    // DOM Elements
    const ui = {
        overlay: document.getElementById('loadingOverlay'),
        loadText: document.getElementById('loadingText'),
        startBtn: document.getElementById('startSystemBtn'),
        matchName: document.getElementById('matchName'),
        matchScore: document.getElementById('matchScore'),
        img: document.getElementById('pokemonImg'),
        icon: document.getElementById('placeholderIcon'),
        canvas: document.getElementById('visualizer'),
        btnRec: document.getElementById('btnRecord'),
        btnStop: document.getElementById('btnStop')
    };

    // --- 1. è‡ªå‹•è®€å–æ¸…å–® (Page Load) ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å… list.txt è¢«å¿«å–
            const response = await fetch('list.txt?nocache=' + Date.now());
            if (!response.ok) throw new Error("æ‰¾ä¸åˆ° list.txt");
            
            const text = await response.text();
            const list = text.split(/\r?\n/).filter(line => line.trim() !== "");

            // å»ºç«‹åŸºç¤è³‡æ–™çµæ§‹
            database = list.map(name => ({ 
                name: name.trim(), 
                buffer: null, 
                signature: null 
            }));
            
            renderGallery();
            
            ui.loadText.innerHTML = `å·²è®€å– ${list.length} ç­†è³‡æ–™<br>è«‹é»æ“Šå•Ÿå‹•`;
            document.querySelector('.fa-spin').style.display = 'none';
            ui.startBtn.style.display = 'inline-block';

        } catch (err) {
            ui.loadText.innerText = "âŒ éŒ¯èª¤: " + err.message;
        }
    });

    // --- 2. å•Ÿå‹• AudioContext ä¸¦åˆ†æè³‡æ–™ ---
    async function startSystem() {
        ui.startBtn.style.display = 'none';
        ui.loadText.innerText = "æ­£åœ¨å»ºç«‹è²ç´‹ç‰¹å¾µåº«...";
        document.querySelector('.fa-spin').style.display = 'inline-block';
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            let loadedCount = 0;
            for (let item of database) {
                try {
                    const res = await fetch(`wav/${item.name}${CONFIG.audioExt}`);
                    if(res.ok) {
                        const buf = await res.arrayBuffer();
                        item.buffer = await audioContext.decodeAudioData(buf);
                        // ğŸ”¥ ç”¢ç”Ÿçµæ§‹çŸ©é™£ç‰¹å¾µ
                        item.signature = await generateAudioSignature(item.buffer);
                        loadedCount++;
                        ui.loadText.innerText = `åˆ†æä¸­ (${loadedCount}/${database.length}):\n${item.name}`;
                    }
                } catch (e) { console.warn(e); }
            }

            // å®Œæˆ
            ui.overlay.style.display = 'none';
            ui.btnRec.disabled = false;
            isSystemStarted = true;

        } catch (err) {
            alert("ç³»çµ±å•Ÿå‹•å¤±æ•—: " + err);
            ui.startBtn.style.display = 'inline-block';
        }
    }

    // --- 3. æ ¸å¿ƒæ¼”ç®—æ³•: è²ç´‹çŸ©é™£ (Spectrogram Signature) ---
    
    // A. éœéŸ³åˆ‡é™¤
    function trimSilence(buffer) {
        const raw = buffer.getChannelData(0);
        let start = 0, end = raw.length - 1;
        while (start < end && Math.abs(raw[start]) < CONFIG.silenceThresh) start++;
        while (end > start && Math.abs(raw[end]) < CONFIG.silenceThresh) end--;
        
        if (end - start < buffer.sampleRate * CONFIG.minDuration) return buffer;
        
        const newLen = end - start + 1;
        const ctx = new OfflineAudioContext(1, newLen, buffer.sampleRate);
        const newBuf = ctx.createBuffer(1, newLen, buffer.sampleRate);
        newBuf.copyToChannel(raw.slice(start, end + 1), 0);
        return newBuf;
    }

    // B. ç”¢ç”Ÿ 2D ç‰¹å¾µçŸ©é™£
    async function generateAudioSignature(audioBuffer) {
        const trimmed = trimSilence(audioBuffer);
        
        // é›¢ç·šé‹ç®—
        const ctx = new OfflineAudioContext(1, trimmed.length, trimmed.sampleRate);
        const source = ctx.createBufferSource();
        source.buffer = trimmed;
        
        const analyser = ctx.createAnalyser();
        analyser.fftSize = CONFIG.fftSize;
        analyser.smoothingTimeConstant = 0.1;
        
        source.connect(analyser);
        analyser.connect(ctx.destination);
        source.start(0);

        // æ™‚é–“è»¸æ­£è¦åŒ–ï¼šå¼·åˆ¶å–å›ºå®šæ•¸é‡çš„ç‰¹å¾µé»
        const duration = trimmed.duration;
        const interval = duration / CONFIG.timeSlices;
        const signature = []; 

        for (let i = 0; i < CONFIG.timeSlices; i++) {
            const t = i * interval;
            const safeT = Math.min(t, duration - 0.001); 
            
            ctx.suspend(safeT).then(() => {
                const fftData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(fftData);
                
                // é »ç‡å£“ç¸® (Binning)
                const bands = new Float32Array(CONFIG.freqBands).fill(0);
                const binSize = Math.floor(fftData.length / CONFIG.freqBands);
                
                for(let b = 0; b < CONFIG.freqBands; b++) {
                    let sum = 0;
                    for(let k = 0; k < binSize; k++) {
                         // å–ç¨å¾®é«˜ä¸€é»çš„é »æ®µï¼Œé¿é–‹ä½é »å™ªéŸ³
                         const idx = b * binSize + k;
                         if(idx < fftData.length) sum += fftData[idx];
                    }
                    bands[b] = sum / binSize;
                }
                signature.push(bands);
            }).then(() => ctx.resume());
        }

        await ctx.startRendering();
        return normalizeSignature(signature);
    }

    // C. çŸ©é™£æ­£è¦åŒ–
    function normalizeSignature(sig) {
        let maxVal = 0;
        for(let t=0; t<sig.length; t++) {
            for(let f=0; f<sig[t].length; f++) {
                if(sig[t][f] > maxVal) maxVal = sig[t][f];
            }
        }
        if(maxVal > 0) {
            for(let t=0; t<sig.length; t++) {
                for(let f=0; f<sig[t].length; f++) {
                    sig[t][f] = sig[t][f] / maxVal;
                }
            }
        }
        return sig;
    }

    // --- 4. æ¯”å°é‚è¼¯ ---
    function compareSignatures(sigA, sigB) {
        if(!sigA || !sigB) return 0;
        
        let dot = 0, normA = 0, normB = 0;
        
        for(let t=0; t<CONFIG.timeSlices; t++) {
            if(!sigA[t] || !sigB[t]) continue;
            for(let f=0; f<CONFIG.freqBands; f++) {
                const valA = sigA[t][f];
                const valB = sigB[t][f];
                dot += valA * valB;
                normA += valA * valA;
                normB += valB * valB;
            }
        }
        
        if(normA === 0 || normB === 0) return 0;
        return dot / (Math.sqrt(normA) * Math.sqrt(normB));
    }

    // --- 5. éŒ„éŸ³æ§åˆ¶ ---
    async function startRecording() {
        switchTab('scan');
        ui.matchName.innerText = "è†è½ä¸­...";
        ui.matchScore.innerText = "...";
        ui.img.style.display = 'none';
        ui.icon.style.display = 'block';

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            // è¦–è¦ºåŒ–
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animationId);
                stream.getTracks().forEach(track => track.stop());
                
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const buf = await audioContext.decodeAudioData(await blob.arrayBuffer());
                
                analyzeInput(buf);
            };

            mediaRecorder.start();
            ui.btnRec.disabled = true;
            ui.btnStop.disabled = false;

        } catch (err) { alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨: " + err); }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            ui.btnRec.disabled = false;
            ui.btnStop.disabled = true;
        }
    }

    async function analyzeInput(inputBuffer) {
        ui.matchName.innerText = "åˆ†æé‹ç®—ä¸­...";
        
        const inputSig = await generateAudioSignature(inputBuffer);
        
        let bestMatch = null;
        let bestScore = -1;

        for (let item of database) {
            const score = compareSignatures(inputSig, item.signature);
            if (score > bestScore) {
                bestScore = score;
                bestMatch = item;
            }
        }

        // é¡¯ç¤ºçµæœ
        const pct = (bestScore * 100).toFixed(1);
        
        // V4.0 çµæ§‹æ¯”å°é€šå¸¸ 0.65 ä»¥ä¸Šå°±æ˜¯å¾ˆåƒäº†
        if (bestScore > 0.65) {
            ui.matchName.innerText = bestMatch.name;
            ui.matchName.style.color = "#0f0";
            ui.matchScore.innerText = `è²ç´‹ç›¸ä¼¼åº¦: ${pct}%`;
            
            ui.img.src = `pic/${bestMatch.name}${CONFIG.imgExt}`;
            ui.img.onload = () => { ui.img.style.display='block'; ui.icon.style.display='none'; };
            ui.img.onerror = () => { ui.img.style.display='none'; ui.icon.style.display='block'; };
        } else {
            ui.matchName.innerText = "ç„¡æ³•è¾¨è­˜";
            ui.matchName.style.color = "#888";
            ui.matchScore.innerText = `æœ€é«˜ç›¸ä¼¼: ${bestMatch ? bestMatch.name : '?'} (${pct}%)`;
            ui.img.style.display='none'; ui.icon.style.display='block';
        }
    }

    // --- UI è¼”åŠ©åŠŸèƒ½ ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        if (mode === 'scan') {
            document.querySelector("button[onclick=\"switchTab('scan')\"]").classList.add('active');
            document.getElementById('scanSection').classList.add('active');
        } else {
            document.querySelector("button[onclick=\"switchTab('gallery')\"]").classList.add('active');
            document.getElementById('gallerySection').classList.add('active');
        }
    }

    function renderGallery() {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';
        database.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `
                <img src="pic/${item.name}${CONFIG.imgExt}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzQ0NCIgZD0iTTEyIDJDMiAyIDIgMTIgMiAxMnMyIDEwIDEwIDEwIDEwLTEwIDEwLTEwUzIyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4IDh6Ii8+PC9zdmc+'">
                <div class="gallery-name">${item.name}</div>
            `;
            div.onclick = () => playSample(item);
            grid.appendChild(div);
        });
    }

    function playSample(item) {
        if (!isSystemStarted) {
            alert("è«‹å…ˆå•Ÿå‹•ç³»çµ±");
            return;
        }
        if (!item.buffer) {
            alert("æ­¤éŸ³æª”è¼‰å…¥å¤±æ•—");
            return;
        }
        const source = audioContext.createBufferSource();
        source.buffer = item.buffer;
        source.connect(audioContext.destination);
        source.start(0);
    }

    function drawVisualizer() {
        animationId = requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);
        const ctx = ui.canvas.getContext('2d');
        const w = ui.canvas.width;
        const h = ui.canvas.height;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
        
        const barW = (w / dataArray.length) * 2.5;
        let x = 0;
        for(let i=0; i<dataArray.length; i++) {
            const barH = (dataArray[i]/255)*h;
            ctx.fillStyle = `hsl(${i/dataArray.length*120}, 100%, 50%)`; // å½©è‰²é »è­œ
            ctx.fillRect(x, h-barH, barW, barH);
            x += barW + 1;
        }
    }
</script>
</body>
</html>