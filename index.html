<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¯¶å¯å¤¢è¾¨è­˜ V5.0 (æ¨¡ç³Šæ¯”å°ç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS ç¶­æŒä¸è®Šï¼Œä¿ç•™ iOS ä¿®æ­£ */
        :root { --pokedex-red: #dc0a2d; --screen-bg: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: #333; margin: 0; display: flex; justify-content: center; height: 100vh; height: 100dvh; overflow: hidden; }
        .pokedex-container { width: 100%; max-width: 480px; background: var(--pokedex-red); height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* é ‚éƒ¨ */
        .top-bar { padding: 15px; display: flex; align-items: center; border-bottom: 5px solid #8b0000; z-index: 10; flex-shrink: 0; }
        .camera-lens { width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, #44d4ff, #005a9e); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.5); margin-right: 15px; }
        .indicators { display: flex; gap: 8px; }
        .led { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
        .led.red { background: #ff5555; } .led.yellow { background: #ffcc00; } .led.green { background: #55ff55; }

        /* è¢å¹• */
        .screen-container { background: #dedede; margin: 15px; padding: 15px; border-radius: 15px 15px 0 0; clip-path: polygon(0 0, 100% 0, 100% 95%, 90% 100%, 0 100%); border: 2px solid #555; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .screen { background: var(--screen-bg); border: 2px solid #555; border-radius: 10px; padding: 10px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; position: relative; }

        /* åˆ†é  */
        .tab-buttons { display: flex; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #444; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; padding: 10px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { color: #0f0; border-bottom: 2px solid #0f0; background: rgba(0,255,0,0.05); }

        .section { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .section.active { display: flex; }

        /* å…§å®¹ */
        canvas { width: 100%; height: 60px; background: #000; border: 1px solid #0f0; margin-bottom: 10px; border-radius: 4px; flex-shrink: 0; }
        .pokemon-display { width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,50,0,0.3); border: 1px dashed #0f0; margin: 5px 0; border-radius: 5px; min-height: 150px; position: relative; }
        .pokemon-display img { max-width: 90%; max-height: 200px; object-fit: contain; display: none; z-index: 2; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .placeholder-icon { color: #0f0; font-size: 4rem; opacity: 0.3; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.6; } 100% { opacity: 0.2; } }

        .result-box { background: rgba(0,0,0,0.8); padding: 10px; width: 95%; text-align: center; border: 1px solid #0f0; border-radius: 5px; margin-top: auto; color: #0f0; font-family: monospace; }
        .result-name { font-size: 1.5rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px #0f0; margin: 5px 0; }
        .debug-info { font-size: 0.7rem; color: #666; margin-top: 5px; white-space: pre-wrap; height: 30px; overflow: hidden; }

        /* åœ–é‘‘ */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; overflow-y: auto; padding-bottom: 20px; }
        .gallery-item { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 5px; cursor: pointer; text-align: center; border: 1px solid transparent; }
        .gallery-item.selected { border-color: #0f0; background: rgba(0,255,0,0.2); }
        .gallery-item img { width: 40px; height: 40px; object-fit: contain; }
        .gallery-name { font-size: 0.7rem; color: #aaa; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: var(--pokedex-red); flex-shrink: 0; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .btn { border: none; padding: 15px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 0 rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-rec { background: #2196F3; } .btn-stop { background: #f44336; }
        .btn:disabled { background: #777; cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }

        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #0f0; font-family: monospace; text-align: center; }
        .start-btn { margin-top: 20px; padding: 10px 25px; background: #0f0; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="top-bar">
        <div class="camera-lens"></div>
        <div class="indicators"><div class="led red"></div><div class="led yellow"></div><div class="led green"></div></div>
    </div>

    <div class="screen-container">
        <div class="screen">
            <div id="loadingOverlay">
                <i class="fas fa-satellite-dish fa-spin fa-2x" style="margin-bottom:15px"></i>
                <div id="loadingText">ç³»çµ±åˆå§‹åŒ–...</div>
                <button id="startBtn" class="start-btn" onclick="initSystem()" style="display:none">å•Ÿå‹•ç³»çµ±</button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scan')">è¾¨è­˜æ¨¡å¼</button>
                <button class="tab-btn" onclick="switchTab('gallery')">è³‡æ–™åº«</button>
            </div>

            <div id="scanSection" class="section active">
                <canvas id="visualizer"></canvas>
                <div class="pokemon-display">
                    <i class="fas fa-fingerprint placeholder-icon" id="placeholderIcon"></i>
                    <img id="pokemonImg" src="">
                </div>
                <div class="result-box">
                    <div class="result-name" id="matchName">---</div>
                    <div style="font-size:0.8rem; color:#aaa" id="matchScore">è«‹é•·æŒ‰éŒ„éŸ³</div>
                    <div class="debug-info" id="debugInfo"></div>
                </div>
            </div>

            <div id="gallerySection" class="section">
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-rec" id="btnRec" disabled onclick="startRec()"><i class="fas fa-microphone fa-lg"></i><br>éŒ„éŸ³</button>
        <button class="btn btn-stop" id="btnStop" disabled onclick="stopRec()"><i class="fas fa-stop fa-lg"></i><br>æ”¾é–‹</button>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ V5.0 åƒæ•¸è¨­å®š (æ¨¡ç³ŠåŒ–ç­–ç•¥)
    // ==========================================
    const CONFIG = {
        audioExt: '.opus',    
        imgExt: '.png',
        fftSize: 1024,
        
        // ğŸ”¥ é—œéµä¿®æ”¹ï¼šé™ä½è§£æåº¦ä»¥é€²è¡Œæ¨¡ç³Šæ¯”å°
        // æˆ‘å€‘å°‡æ•´å€‹è²éŸ³ç¸®å°æˆ 12x12 çš„ç¶²æ ¼ï¼Œåªçœ‹å¤§ç•¥å½¢ç‹€
        gridTime: 12,  
        gridFreq: 12,  
        
        silenceThresh: 0.03, // ç¨å¾®æé«˜éœéŸ³é–€æª»ï¼Œéæ¿¾èƒŒæ™¯é›œéŸ³
        minDuration: 0.3,    // è‡³å°‘è¦éŒ„ 0.3 ç§’
        
        // ğŸ† ç›¸å°å„ªå‹¢åˆ¤å®š
        winMargin: 1.05      // ç¬¬ä¸€ååˆ†æ•¸å¿…é ˆæ˜¯ç¬¬äºŒåçš„ 1.05 å€æ‰ç®—è´ï¼Œå¦å‰‡ç®—ã€Œä¸ç¢ºå®šã€
    };

    let audioCtx, database = [], mediaRecorder, audioChunks = [], analyser, animId;
    let isInit = false;

    // DOM
    const ui = {
        overlay: document.getElementById('loadingOverlay'),
        text: document.getElementById('loadingText'),
        start: document.getElementById('startBtn'),
        name: document.getElementById('matchName'),
        score: document.getElementById('matchScore'),
        debug: document.getElementById('debugInfo'),
        img: document.getElementById('pokemonImg'),
        icon: document.getElementById('placeholderIcon'),
        canvas: document.getElementById('visualizer'),
        btnRec: document.getElementById('btnRec'),
        btnStop: document.getElementById('btnStop')
    };

    // 1. åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('list.txt?nocache=' + Date.now());
            if(!res.ok) throw new Error("ç„¡ list.txt");
            const txt = await res.text();
            const list = txt.split(/\r?\n/).filter(l => l.trim());
            
            database = list.map(n => ({ name: n.trim(), buffer: null, grid: null }));
            renderGallery();
            
            ui.text.innerHTML = `å·²è®€å– ${list.length} ç­†<br>å»ºè­°ä½¿ç”¨ã€äººè²éŒ„éŸ³ã€‘ä½œç‚ºæ¨™æº–`;
            document.querySelector('.fa-spin').style.display = 'none';
            ui.start.style.display = 'inline-block';
        } catch(e) { ui.text.innerText = "Error: " + e.message; }
    });

    async function initSystem() {
        ui.start.style.display = 'none';
        ui.text.innerText = "åˆ†æè²ç´‹ç‰¹å¾µä¸­...";
        document.querySelector('.fa-spin').style.display = 'inline-block';
        
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            for(let item of database) {
                try {
                    const res = await fetch(`wav/${item.name}${CONFIG.audioExt}`);
                    if(res.ok) {
                        const buf = await res.arrayBuffer();
                        item.buffer = await audioCtx.decodeAudioData(buf);
                        // ç”¢ç”Ÿã€Œæ¨¡ç³Šç‰¹å¾µç¶²æ ¼ã€
                        item.grid = await createFuzzyGrid(item.buffer);
                    }
                } catch(e) { console.warn(item.name, e); }
            }
            ui.overlay.style.display = 'none';
            ui.btnRec.disabled = false;
            isInit = true;
        } catch(e) { alert("å•Ÿå‹•å¤±æ•—: " + e); }
    }

    // 2. æ ¸å¿ƒï¼šå»ºç«‹æ¨¡ç³Šç‰¹å¾µç¶²æ ¼ (Fuzzy Grid)
    async function createFuzzyGrid(buffer) {
        // A. åˆ‡é™¤éœéŸ³
        const raw = buffer.getChannelData(0);
        let s = 0, e = raw.length - 1;
        while(s < e && Math.abs(raw[s]) < CONFIG.silenceThresh) s++;
        while(e > s && Math.abs(raw[e]) < CONFIG.silenceThresh) e--;
        if(e - s < buffer.sampleRate * CONFIG.minDuration) return null; // å¤ªçŸ­ç„¡æ•ˆ

        const trimmed = raw.slice(s, e+1);
        
        // B. é›¢ç·š FFT
        const ctx = new OfflineAudioContext(1, trimmed.length, buffer.sampleRate);
        const source = ctx.createBufferSource();
        const buf = ctx.createBuffer(1, trimmed.length, buffer.sampleRate);
        buf.copyToChannel(trimmed, 0);
        source.buffer = buf;
        
        const analyser = ctx.createAnalyser();
        analyser.fftSize = CONFIG.fftSize;
        source.connect(analyser);
        analyser.connect(ctx.destination);
        source.start(0);

        // C. ç¶²æ ¼åŒ– (Downsampling)
        // å¼·åˆ¶å°‡è²éŸ³åˆ‡æˆ gridTime å€‹æ™‚é–“é»
        const duration = buf.duration;
        const interval = duration / CONFIG.gridTime;
        const grid = [];

        for(let i=0; i<CONFIG.gridTime; i++) {
            const t = i * interval;
            // é¿é–‹æœ€å¾Œé‚Šç•Œ
            const safeT = Math.min(t, duration - 0.01);
            
            ctx.suspend(safeT).then(() => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                
                // é »ç‡å£“ç¸®: å°‡ 512 å€‹é »ç‡é»å£“ç¸®æˆ gridFreq å€‹å€å¡Š (å–æœ€å¤§å€¼ Max Pooling)
                // ä½¿ç”¨ Max Pooling å¯ä»¥æŠ“åˆ°ã€Œä¸»éŸ³ã€ï¼Œå¿½ç•¥éŸ³è‰²ç´°ç¯€
                const col = new Float32Array(CONFIG.gridFreq);
                const binSize = Math.floor(data.length / CONFIG.gridFreq);
                
                for(let b=0; b<CONFIG.gridFreq; b++) {
                    let maxVal = 0;
                    // å¿½ç•¥æ¥µä½é » (å‰ 5% çš„ bin)ï¼Œé€šå¸¸æ˜¯ç’°å¢ƒå™ªéŸ³
                    const startBin = b * binSize + Math.floor(data.length * 0.05); 
                    const endBin = startBin + binSize;
                    
                    for(let k=startBin; k<endBin; k++) {
                        if(k < data.length && data[k] > maxVal) maxVal = data[k];
                    }
                    col[b] = maxVal;
                }
                grid.push(col);
            }).then(() => ctx.resume());
        }

        await ctx.startRendering();
        
        // D. 2D æ­£è¦åŒ– (è®“æ•¸å€¼åˆ†ä½ˆåœ¨ 0~1)
        let maxGlobal = 0;
        grid.forEach(col => col.forEach(v => { if(v>maxGlobal) maxGlobal=v; }));
        if(maxGlobal > 0) {
            grid.forEach(col => col.forEach((v,i) => col[i] = v/maxGlobal));
        }
        
        return grid; // å›å‚³ 12x12 çš„ç‰¹å¾µçŸ©é™£
    }

    // 3. æ¯”å°é‚è¼¯ï¼šçŸ©é™£é‡ç–Šç‡
    function compareGrids(g1, g2) {
        if(!g1 || !g2) return 0;
        let score = 0;
        let total = 0;
        
        // é€æ ¼æ¯”å°
        for(let t=0; t<CONFIG.gridTime; t++) {
            if(!g1[t] || !g2[t]) continue;
            for(let f=0; f<CONFIG.gridFreq; f++) {
                // ç°¡å–®çš„å·®å€¼æ¯”å°ï¼šå…©è€…è¶Šæ¥è¿‘ï¼Œåˆ†æ•¸è¶Šé«˜
                const diff = Math.abs(g1[t][f] - g2[t][f]);
                score += (1 - diff); // å·® 0 å¾— 1 åˆ†ï¼Œå·® 1 å¾— 0 åˆ†
                total++;
            }
        }
        return total > 0 ? score / total : 0;
    }

    // 4. éŒ„éŸ³æ“ä½œ
    async function startRec() {
        switchTab('scan');
        ui.name.innerText = "è†è½ä¸­...";
        ui.score.innerText = "...";
        ui.debug.innerText = "";
        ui.img.style.display='none'; ui.icon.style.display='block';
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            const src = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            visualize();

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animId);
                stream.getTracks().forEach(t => t.stop());
                const blob = new Blob(audioChunks, {type:'audio/webm'});
                const buf = await audioCtx.decodeAudioData(await blob.arrayBuffer());
                analyze(buf);
            };
            mediaRecorder.start();
            ui.btnRec.disabled = true; ui.btnStop.disabled = false;
        } catch(e) { alert("Mic Error: "+e); }
    }

    function stopRec() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            ui.btnRec.disabled = false; ui.btnStop.disabled = true;
        }
    }

    async function analyze(inputBuf) {
        ui.name.innerText = "é‹ç®—ä¸­...";
        const inputGrid = await createFuzzyGrid(inputBuf);
        
        if(!inputGrid) {
            ui.name.innerText = "è²éŸ³å¤ªçŸ­æˆ–å¤ªå°";
            return;
        }

        // é€²è¡Œæ’å
        let results = database.map(item => {
            return {
                name: item.name,
                score: compareGrids(inputGrid, item.grid),
                obj: item
            };
        });

        // æ’åºï¼šåˆ†æ•¸é«˜åˆ°ä½
        results.sort((a, b) => b.score - a.score);
        
        const winner = results[0];
        const runnerUp = results[1];
        
        // Debug é¡¯ç¤ºå‰ä¸‰å
        ui.debug.innerText = results.slice(0,3).map(r => `${r.name}: ${(r.score*100).toFixed(0)}`).join(' / ');

        // åˆ¤å®šé‚è¼¯ï¼šç›¸å°å„ªå‹¢
        // å¦‚æœç¬¬ä¸€ååˆ†æ•¸å¤§æ–¼ 0.4 (åŸºæœ¬é–€æª») ä¸” (æ²’æœ‰ç¬¬äºŒå æˆ– ç¬¬ä¸€åæ˜é¡¯è´éç¬¬äºŒå)
        const isValidWin = winner.score > 0.4 && (!runnerUp || winner.score > runnerUp.score * CONFIG.winMargin);

        if (isValidWin) {
            ui.name.innerText = winner.name;
            ui.name.style.color = "#0f0";
            ui.score.innerText = `ç›¸ä¼¼åº¦: ${(winner.score*100).toFixed(1)}%`;
            ui.img.src = `pic/${winner.name}${CONFIG.imgExt}`;
            ui.img.onload = () => { ui.img.style.display='block'; ui.icon.style.display='none'; };
            ui.img.onerror = () => { ui.img.style.display='none'; ui.icon.style.display='block'; };
        } else {
            // é›–ç„¶æœ‰ç¬¬ä¸€åï¼Œä½†è´å¾—ä¸å¤ å¤šï¼Œæˆ–æ˜¯åˆ†æ•¸å¤ªä½
            ui.name.innerText = "ç„¡æ³•è¾¨è­˜";
            ui.name.style.color = "#888";
            ui.score.innerText = runnerUp ? `åƒ ${winner.name} ä½†ä¹Ÿåƒ ${runnerUp.name}` : "ç‰¹å¾µä¸æ˜é¡¯";
            ui.img.style.display='none'; ui.icon.style.display='block';
        }
    }

    // UI Funcs
    function switchTab(m) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        if(m==='scan') {
            document.querySelector("button[onclick=\"switchTab('scan')\"]").classList.add('active');
            document.getElementById('scanSection').classList.add('active');
        } else {
            document.querySelector("button[onclick=\"switchTab('gallery')\"]").classList.add('active');
            document.getElementById('gallerySection').classList.add('active');
        }
    }

    function renderGallery() {
        const g = document.getElementById('galleryGrid');
        g.innerHTML = '';
        database.forEach(d => {
            const el = document.createElement('div');
            el.className = 'gallery-item';
            el.innerHTML = `<img src="pic/${d.name}${CONFIG.imgExt}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzQ0NCIgZD0iTTEyIDJDMiAyIDIgMTIgMiAxMnMyIDEwIDEwIDEwIDEwLTEwIDEwLTEwUzIyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4IDh6Ii8+PC9zdmc+'"><div class="gallery-name">${d.name}</div>`;
            el.onclick = () => {
                if(isInit && d.buffer) {
                    const s = audioCtx.createBufferSource(); s.buffer = d.buffer; s.connect(audioCtx.destination); s.start(0);
                }
            };
            g.appendChild(el);
        });
    }

    function visualize() {
        animId = requestAnimationFrame(visualize);
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);
        const ctx = ui.canvas.getContext('2d');
        const w = ui.canvas.width, h = ui.canvas.height;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
        const barW = (w/data.length)*2.5; let x=0;
        for(let i=0; i<data.length; i++) {
            const barH = (data[i]/255)*h;
            ctx.fillStyle = `hsl(${i/data.length*120},100%,50%)`;
            ctx.fillRect(x, h-barH, barW, barH); x+=barW+1;
        }
    }
</script>
</body>
</html>