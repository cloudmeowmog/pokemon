<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢è²ç´‹è¾¨è­˜å™¨ V4.0 (çµæ§‹æ¯”å°ç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS æ¨£å¼ç¶­æŒä¸€è‡´ï¼ŒåŠ å…¥ä¸€é»ç§‘æŠ€æ„Ÿèª¿æ•´ */
        :root { --pokedex-red: #dc0a2d; --screen-bg: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: #333; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .pokedex-container { width: 100%; max-width: 480px; background: var(--pokedex-red); height: 100%; display: flex; flex-direction: column; position: relative; }
        
        .top-bar { padding: 15px; display: flex; align-items: center; border-bottom: 4px solid #8b0000; box-shadow: 0 4px 5px rgba(0,0,0,0.2); z-index: 10; flex-shrink: 0; }
        .camera-lens { width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, #44d4ff, #005a9e); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.5); margin-right: 15px; }
        
        .screen-container { background: #dedede; margin: 15px; padding: 15px; border-radius: 10px 10px 0 0; border: 2px solid #555; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .screen { background: var(--screen-bg); border: 2px solid #555; border-radius: 8px; padding: 10px; flex-grow: 1; display: flex; flex-direction: column; align-items: center; position: relative; overflow-y: auto; }

        .tab-buttons { display: flex; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #444; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; padding: 10px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #0f0; border-bottom: 2px solid #0f0; background: rgba(0,255,0,0.05); }

        .section { display: none; width: 100%; flex-direction: column; align-items: center; height: 100%; }
        .section.active { display: flex; }

        /* è¦–è¦ºåŒ–èˆ‡çµæœå€ */
        canvas { width: 100%; height: 80px; background: #000; border: 1px solid #0f0; margin-bottom: 10px; flex-shrink: 0; }
        .pokemon-display { width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,50,0,0.3); border: 1px dashed #0f0; margin: 5px 0; border-radius: 5px; min-height: 150px; position: relative; }
        .pokemon-display img { max-width: 90%; max-height: 200px; object-fit: contain; display: none; z-index: 2; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .placeholder-icon { color: #0f0; font-size: 4rem; opacity: 0.3; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.6; } 100% { opacity: 0.2; } }

        .result-box { width: 100%; text-align: center; color: #0f0; font-family: monospace; margin-top: auto; padding: 5px; background: rgba(0,0,0,0.5); border-radius: 4px; }
        .result-name { font-size: 1.5rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px #0f0; }

        /* åœ–é‘‘ç¶²æ ¼ */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; overflow-y: auto; padding-bottom: 20px; }
        .gallery-item { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 5px; cursor: pointer; text-align: center; border: 1px solid transparent; transition: 0.2s; }
        .gallery-item:hover { border-color: #0f0; background: rgba(0,255,0,0.1); }
        .gallery-item img { width: 50px; height: 50px; object-fit: contain; }
        .gallery-name { font-size: 0.7rem; color: #aaa; margin-top: 3px; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: var(--pokedex-red); flex-shrink: 0; }
        .btn { border: none; padding: 15px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 0 rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-record { background: #2196F3; }
        .btn-stop { background: #f44336; }
        .btn:disabled { background: #777; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }

        #loadingOverlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#0f0; font-family:monospace; }
    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="top-bar">
        <div class="camera-lens"></div>
        <div style="flex-grow:1"></div>
        <div style="display:flex; gap:5px">
            <div style="width:10px; height:10px; background:red; border-radius:50%"></div>
            <div style="width:10px; height:10px; background:yellow; border-radius:50%"></div>
            <div style="width:10px; height:10px; background:#0f0; border-radius:50%"></div>
        </div>
    </div>

    <div class="screen-container">
        <div class="screen">
            <div id="loadingOverlay">
                <i class="fas fa-satellite-dish fa-spin fa-2x" style="margin-bottom:15px"></i>
                <div id="loadingText">åˆå§‹åŒ–ç³»çµ±...</div>
                <button onclick="startSystem()" id="startBtn" style="margin-top:20px; padding:10px 20px; background:#0f0; border:none; border-radius:5px; font-weight:bold; cursor:pointer; display:none;">
                    å•Ÿå‹•è¾¨è­˜ç³»çµ±
                </button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scan')">è²ç´‹æ¯”å°</button>
                <button class="tab-btn" onclick="switchTab('gallery')">è²éŸ³è³‡æ–™åº«</button>
            </div>

            <div id="scanSection" class="section active">
                <canvas id="visualizer"></canvas>
                <div class="pokemon-display">
                    <i class="fas fa-fingerprint placeholder-icon" id="placeholderIcon"></i>
                    <img id="pokemonImg" src="">
                </div>
                <div class="result-box">
                    <div class="result-name" id="matchName">---</div>
                    <div style="font-size:0.8rem; color:#aaa" id="matchScore">è«‹é•·æŒ‰ä¸‹æ–¹æŒ‰éˆ•éŒ„éŸ³</div>
                </div>
            </div>

            <div id="gallerySection" class="section">
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-record" id="btnRecord" disabled onclick="startRecording()">
            <i class="fas fa-microphone fa-lg"></i><br>éŒ„éŸ³
        </button>
        <button class="btn btn-stop" id="btnStop" disabled onclick="stopRecording()">
            <i class="fas fa-stop fa-lg"></i><br>æ”¾é–‹
        </button>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šåƒæ•¸
    // ==========================================
    const CONFIG = {
        audioExt: '.opus',    // è²éŸ³æª”å‰¯æª”å
        imgExt: '.png',      // åœ–ç‰‡æª”å‰¯æª”å
        fftSize: 1024,       // è§£æåº¦
        timeSlices: 30,      // å°‡è²éŸ³åˆ‡æˆ 30 å€‹æ™‚é–“ç‰‡æ®µ (Time Normalization)
        freqBands: 32,       // å°‡é »ç‡åˆ‡æˆ 32 å€‹å€é–“ (Frequency Binning)
        silenceThresh: 0.02, // éœéŸ³éæ¿¾é–€æª»
        minDuration: 0.2     // æœ€å°æœ‰æ•ˆç§’æ•¸
    };

    // ==========================================
    // ğŸš€ å…¨åŸŸè®Šæ•¸
    // ==========================================
    let audioCtx;
    let database = []; // {name, buffer, signature}
    let mediaRecorder;
    let audioChunks = [];
    let analyser, dataArray, animId;
    let isStarted = false;

    // DOM
    const ui = {
        loadOverlay: document.getElementById('loadingOverlay'),
        loadText: document.getElementById('loadingText'),
        startBtn: document.getElementById('startBtn'),
        matchName: document.getElementById('matchName'),
        matchScore: document.getElementById('matchScore'),
        img: document.getElementById('pokemonImg'),
        icon: document.getElementById('placeholderIcon'),
        canvas: document.getElementById('visualizer')
    };

    // --- 1. åˆå§‹åŒ–ç¨‹åº ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // è®€å–æ¸…å–®
            const res = await fetch('list.txt?t=' + Date.now());
            if(!res.ok) throw new Error("ç¼ºå°‘ list.txt");
            const txt = await res.text();
            const list = txt.split(/\r?\n/).filter(line => line.trim());

            // å»ºç«‹ç©ºè³‡æ–™çµæ§‹
            database = list.map(name => ({ name: name.trim(), buffer: null, signature: null }));
            
            // æ¸²æŸ“åœ–é‘‘
            renderGallery();
            
            ui.loadText.innerHTML = `å·²è®€å– ${list.length} éš»å¯¶å¯å¤¢<br>æº–å‚™å°±ç·’`;
            document.querySelector('.fa-spin').style.display = 'none';
            ui.startBtn.style.display = 'inline-block';
        } catch (e) {
            ui.loadText.innerText = "éŒ¯èª¤: " + e.message;
        }
    });

    async function startSystem() {
        ui.startBtn.style.display = 'none';
        ui.loadText.innerText = "æ­£åœ¨åˆ†æè²ç´‹çµæ§‹ (é‹ç®—ä¸­)...";
        document.querySelector('.fa-spin').style.display = 'inline-block';

        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            let loaded = 0;
            for(let item of database) {
                try {
                    const res = await fetch(`wav/${item.name}${CONFIG.audioExt}`);
                    if(res.ok) {
                        const buf = await res.arrayBuffer();
                        item.buffer = await audioCtx.decodeAudioData(buf);
                        // ğŸ”¥ ç”¢ç”Ÿçµæ§‹ç‰¹å¾µ (Signature)
                        item.signature = await generateAudioSignature(item.buffer);
                        loaded++;
                        ui.loadText.innerText = `åˆ†æä¸­ (${loaded}/${database.length}): ${item.name}`;
                    }
                } catch(err) { console.error(item.name, err); }
            }
            
            ui.loadOverlay.style.display = 'none';
            document.getElementById('btnRecord').disabled = false;
            isStarted = true;
        } catch(err) {
            alert("AudioContext Error: " + err);
        }
    }

    // --- 2. æ ¸å¿ƒæ¼”ç®—æ³•: è²ç´‹çŸ©é™£ (Spectrogram Signature) ---
    
    // æ­¥é©Ÿ A: åˆ‡é™¤éœéŸ³
    function trimSilence(buffer) {
        const raw = buffer.getChannelData(0);
        let start = 0, end = raw.length - 1;
        while (start < end && Math.abs(raw[start]) < CONFIG.silenceThresh) start++;
        while (end > start && Math.abs(raw[end]) < CONFIG.silenceThresh) end--;
        
        if (end - start < buffer.sampleRate * CONFIG.minDuration) return buffer; // å¤ªçŸ­å°±ä¸åˆ‡äº†
        
        const newLen = end - start + 1;
        const ctx = new OfflineAudioContext(1, newLen, buffer.sampleRate);
        const newBuf = ctx.createBuffer(1, newLen, buffer.sampleRate);
        newBuf.copyToChannel(raw.slice(start, end + 1), 0);
        return newBuf;
    }

    // æ­¥é©Ÿ B: ç”¢ç”Ÿ 2D ç‰¹å¾µçŸ©é™£
    async function generateAudioSignature(audioBuffer) {
        // 1. å»é ­å»å°¾
        const trimmed = trimSilence(audioBuffer);
        
        // 2. é›¢ç·šé‹ç®—é »è­œ
        const ctx = new OfflineAudioContext(1, trimmed.length, trimmed.sampleRate);
        const source = ctx.createBufferSource();
        source.buffer = trimmed;
        
        const analyser = ctx.createAnalyser();
        analyser.fftSize = CONFIG.fftSize;
        analyser.smoothingTimeConstant = 0.1; // ç¨å¾®å¹³æ»‘ä¸€é»
        
        source.connect(analyser);
        analyser.connect(ctx.destination);
        source.start(0);

        // 3. æˆ‘å€‘éœ€è¦ã€Œæ™‚é–“è»¸æ­£è¦åŒ–ã€ï¼šç„¡è«–é•·çŸ­ï¼Œéƒ½å– 30 å€‹ç‰¹å¾µé»
        const duration = trimmed.duration;
        const interval = duration / CONFIG.timeSlices;
        const signature = []; // é€™å°‡æ˜¯ä¸€å€‹ 30 x 32 çš„äºŒç¶­é™£åˆ—

        // é å…ˆå®‰æ’æ’ç¨‹ä¾†æŠ“å–è³‡æ–™
        // Web Audio API çš„ Offline Context ç„¡æ³•å³æ™‚ callbackï¼Œ
        // ä½†æˆ‘å€‘å¯ä»¥åˆ©ç”¨ ScriptProcessor (èˆŠ) æˆ– AudioWorklet (æ–°)ã€‚
        // ç‚ºäº†ç›¸å®¹èˆ‡ç°¡å–®ï¼Œæˆ‘å€‘ç”¨ä¸€ç¨®ç°¡å–®çš„ hack: 
        // å¯¦éš›ä¸Šï¼ŒOfflineContext render å®Œå¾Œæˆ‘å€‘æ‹¿ä¸åˆ°ä¸­é–“çš„ analyser dataã€‚
        // æ‰€ä»¥ï¼Œæˆ‘å€‘å¿…é ˆé‡å°ã€Œæ¯å€‹æ™‚é–“åˆ‡ç‰‡ã€éƒ½è·‘ä¸€æ¬¡ suspend/resume (æ¨™æº–åšæ³•)ã€‚

        // è¨­å®šæ™‚é–“æª¢æŸ¥é»
        for (let i = 0; i < CONFIG.timeSlices; i++) {
            const t = i * interval;
            // é¿é–‹æœ€å¾Œä¸€ç¬é–“ï¼Œä»¥å…æ²’æ•¸æ“š
            const safeT = Math.min(t, duration - 0.001); 
            
            ctx.suspend(safeT).then(() => {
                const fftData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(fftData);
                
                // å£“ç¸®é »ç‡ï¼šå°‡ 512 å€‹é »ç‡é»æ¿ƒç¸®æˆ 32 å€‹é »æ®µ (Mel-like Log Scale)
                const bands = new Float32Array(CONFIG.freqBands).fill(0);
                for(let b = 0; b < CONFIG.freqBands; b++) {
                    // ç°¡å–®çš„ç·šæ€§æˆ–å°æ•¸åˆ†çµ„ï¼Œé€™è£¡ç”¨ç°¡å–®çš„ç·šæ€§åˆ†çµ„ç¤ºç¯„ (ä½é »æ¬Šé‡é«˜)
                    // ç‚ºäº†æŠ“é›»å­éŸ³ï¼Œæˆ‘å€‘é—œæ³¨ä¸­é«˜é »
                    const startBin = Math.floor(b * (fftData.length / CONFIG.freqBands));
                    const endBin = Math.floor((b + 1) * (fftData.length / CONFIG.freqBands));
                    let sum = 0;
                    for(let k = startBin; k < endBin; k++) {
                        sum += fftData[k];
                    }
                    bands[b] = sum / (endBin - startBin);
                }
                signature.push(bands); // å­˜å…¥ä¸€å€‹æ™‚é–“é»çš„ç‰¹å¾µ
            }).then(() => ctx.resume());
        }

        await ctx.startRendering();
        
        // æ­£è¦åŒ–çŸ©é™£æ•¸å€¼ (è®“æ‰€æœ‰æ•¸å€¼è½åœ¨ 0~1 ä¹‹é–“)
        return normalizeSignature(signature);
    }

    // æ­¥é©Ÿ C: çŸ©é™£æ­¸ä¸€åŒ–
    function normalizeSignature(sig) {
        let maxVal = 0;
        // æ‰¾æœ€å¤§å€¼
        for(let t=0; t<sig.length; t++) {
            for(let f=0; f<sig[t].length; f++) {
                if(sig[t][f] > maxVal) maxVal = sig[t][f];
            }
        }
        // é™¤ä»¥æœ€å¤§å€¼
        if(maxVal > 0) {
            for(let t=0; t<sig.length; t++) {
                for(let f=0; f<sig[t].length; f++) {
                    sig[t][f] = sig[t][f] / maxVal;
                }
            }
        }
        return sig;
    }

    // --- 3. æ¯”å°æ¼”ç®—æ³•: çŸ©é™£ç›¸ä¼¼åº¦ (Matrix Similarity) ---
    function compareSignatures(sigA, sigB) {
        if(!sigA || !sigB || sigA.length === 0 || sigB.length === 0) return 0;

        // å› ç‚ºæˆ‘å€‘å¼·åˆ¶æ­£è¦åŒ–æ™‚é–“æˆ 30 å€‹åˆ‡ç‰‡ï¼Œæ‰€ä»¥ sigA å’Œ sigB çš„ç¶­åº¦æ˜¯ä¸€æ¨£çš„ (30 x 32)
        // ä½¿ç”¨ é¤˜å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity) è¨ˆç®—å…©å€‹ã€Œå±•é–‹å¾Œçš„å¤§å‘é‡ã€
        
        let dot = 0, normA = 0, normB = 0;
        
        for(let t=0; t<CONFIG.timeSlices; t++) {
            // å¦‚æœæ¯”å°çš„ä¾†æºé•·åº¦ä¸è¶³ (é˜²å‘†)
            if(!sigA[t] || !sigB[t]) continue;

            for(let f=0; f<CONFIG.freqBands; f++) {
                const valA = sigA[t][f];
                const valB = sigB[t][f];
                
                dot += valA * valB;
                normA += valA * valA;
                normB += valB * valB;
            }
        }
        
        if(normA === 0 || normB === 0) return 0;
        return dot / (Math.sqrt(normA) * Math.sqrt(normB));
    }

    // --- 4. éŒ„éŸ³èˆ‡äº’å‹•é‚è¼¯ ---
    async function startRecording() {
        switchTab('scan');
        ui.matchName.innerText = "è†è½ä¸­...";
        ui.matchScore.innerText = "...";
        ui.img.style.display = 'none';
        ui.icon.style.display = 'block';
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            // è¦–è¦ºåŒ–
            const src = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animId);
                stream.getTracks().forEach(t => t.stop());
                
                // è™•ç†éŒ„éŸ³
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const buf = await audioCtx.decodeAudioData(await blob.arrayBuffer());
                analyzeInput(buf);
            };

            mediaRecorder.start();
            document.getElementById('btnRecord').disabled = true;
            document.getElementById('btnStop').disabled = false;
        } catch(e) { alert("Mic Error: " + e); }
    }

    function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('btnRecord').disabled = false;
            document.getElementById('btnStop').disabled = true;
        }
    }

    async function analyzeInput(inputBuffer) {
        ui.matchName.innerText = "æ¯”å°é »è­œçµæ§‹...";
        
        // ç”¢ç”ŸéŒ„éŸ³çš„ç‰¹å¾µ
        const inputSig = await generateAudioSignature(inputBuffer);
        
        let bestMatch = null;
        let bestScore = -1;

        for(let item of database) {
            const score = compareSignatures(inputSig, item.signature);
            if(score > bestScore) {
                bestScore = score;
                bestMatch = item;
            }
        }

        // é¡¯ç¤ºçµæœ
        // çµæ§‹æ¯”å°çš„ç›¸ä¼¼åº¦é€šå¸¸æœƒæ¯”å–®ç´”é »è­œå¹³å‡ä½ä¸€é»ï¼Œæ‰€ä»¥é–€æª»è¨­ 0.65 å·¦å³
        const pct = (bestScore * 100).toFixed(1);
        
        if(bestScore > 0.65) {
            ui.matchName.innerText = bestMatch.name;
            ui.matchName.style.color = "#0f0";
            ui.matchScore.innerText = `çµæ§‹ç›¸ä¼¼åº¦: ${pct}%`;
            ui.img.src = `pic/${bestMatch.name}${CONFIG.imgExt}`;
            ui.img.onload = () => { ui.img.style.display='block'; ui.icon.style.display='none'; };
            ui.img.onerror = () => { ui.img.style.display='none'; ui.icon.style.display='block'; };
        } else {
            ui.matchName.innerText = "ç„¡æ³•è¾¨è­˜";
            ui.matchName.style.color = "#888";
            ui.matchScore.innerText = `æœ€é«˜ç›¸ä¼¼: ${bestMatch ? bestMatch.name : '?'} (${pct}%)`;
            ui.img.style.display='none'; 
            ui.icon.style.display='block';
        }
    }

    // --- UI è¼”åŠ© ---
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        if(t==='scan') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('scanSection').classList.add('active');
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('gallerySection').classList.add('active');
        }
    }

    function renderGallery() {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';
        database.forEach(item => {
            const el = document.createElement('div');
            el.className = 'gallery-item';
            el.innerHTML = `
                <img src="pic/${item.name}${CONFIG.imgExt}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzQ0NCIgZD0iTTEyIDJDMiAyIDIgMTIgMiAxMnMyIDEwIDEwIDEwIDEwLTEwIDEwLTEwUzIyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4IDh6Ii8+PC9zdmc+'">
                <div class="gallery-name">${item.name}</div>
            `;
            el.onclick = () => playSound(item);
            grid.appendChild(el);
        });
    }

    function playSound(item) {
        if(!isStarted || !item.buffer) return;
        const src = audioCtx.createBufferSource();
        src.buffer = item.buffer;
        src.connect(audioCtx.destination);
        src.start(0);
    }

    function drawVisualizer() {
        animId = requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);
        const ctx = ui.canvas.getContext('2d');
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,ui.canvas.width,ui.canvas.height);
        const barW = (ui.canvas.width / dataArray.length) * 2.5;
        let x = 0;
        for(let i=0; i<dataArray.length; i++) {
            const h = (dataArray[i]/255)*ui.canvas.height;
            ctx.fillStyle = `hsl(${i/dataArray.length*120}, 100%, 50%)`;
            ctx.fillRect(x, ui.canvas.height-h, barW, h);
            x += barW+1;
        }
    }

</script>
</body>
</html>