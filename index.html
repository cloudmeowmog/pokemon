<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢è²ç´‹è¾¨è­˜å™¨ (Listç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pokedex-red: #dc0a2d;
            --pokedex-dark-red: #8b0000;
            --screen-bg: #222;
            --ui-blue: #2196F3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .pokedex-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--pokedex-red);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Top Sensor Bar */
        .top-bar {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 5px solid var(--pokedex-dark-red);
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .camera-lens {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #44d4ff, #005a9e);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-right: 15px;
        }

        .indicators {
            display: flex;
            gap: 10px;
        }

        .led {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .led.red { background-color: #ff5555; }
        .led.yellow { background-color: #ffcc00; }
        .led.green { background-color: #55ff55; }

        /* Main Screen Area */
        .screen-container {
            background-color: #dedede;
            margin: 20px;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 85% 100%, 0 100%);
            border: 2px solid #555;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .screen {
            background-color: var(--screen-bg);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            overflow: hidden;
        }

        h2 {
            margin-top: 0;
            color: #0f0;
            font-size: 1rem;
            text-transform: uppercase;
            border-bottom: 1px solid #0f0;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
            letter-spacing: 2px;
            font-family: 'Courier New', Courier, monospace;
        }

        /* Controls */
        .control-panel {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background-color: var(--pokedex-red);
        }

        .btn {
            border: none;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-load { background-color: #4CAF50; grid-column: 1 / -1; }
        .btn-record { background-color: #2196F3; }
        .btn-stop { background-color: #f44336; }
        .btn:disabled { background-color: #777; cursor: not-allowed; box-shadow: none; transform: none; opacity: 0.7;}

        /* Visualizer */
        canvas {
            width: 100%;
            height: 80px;
            background-color: #000;
            border: 1px solid #0f0;
            border-radius: 4px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        /* Status & Image */
        .status-text {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 0.8rem;
            margin: 5px 0;
            color: #0f0;
            width: 100%;
            text-align: center;
            white-space: pre-wrap;
            text-shadow: 0 0 5px #0f0;
        }

        .pokemon-display {
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 50, 0, 0.5);
            border-radius: 5px;
            margin: 10px 0;
            border: 1px dashed #0f0;
            overflow: hidden;
            position: relative;
        }

        .pokemon-display::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .pokemon-display img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            display: none; 
            z-index: 1;
        }
        
        .placeholder-icon {
            color: #0f0;
            font-size: 4rem;
            opacity: 0.5;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }

        .result-box {
            background-color: #000;
            padding: 10px;
            border-radius: 5px;
            width: 95%;
            text-align: center;
            border: 1px solid #0f0;
            margin-top: auto;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .result-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            margin: 5px 0;
        }
        
        .result-score {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .tech-info {
            font-size: 0.7rem;
            color: #0f0;
            margin-top: 5px;
            opacity: 0.7;
        }

    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="top-bar">
        <div class="camera-lens"></div>
        <div class="indicators">
            <div class="led red"></div>
            <div class="led yellow"></div>
            <div class="led green"></div>
        </div>
    </div>

    <div class="screen-container">
        <div class="screen">
            <h2>è²ç´‹åˆ†æå„€ (å¤–éƒ¨åå–®ç‰ˆ)</h2>
            <canvas id="visualizer"></canvas>
            
            <div class="status-text" id="statusMsg">ç³»çµ±å¾…æ©Ÿä¸­...</div>

            <div class="pokemon-display" id="imgContainer">
                <i class="fas fa-wave-square placeholder-icon" id="placeholderIcon"></i>
                <img id="pokemonImg" src="" alt="Pokemon">
            </div>

            <div class="result-box" id="resultArea" style="visibility: hidden;">
                <div class="tech-info">MATCHING ALGORITHM: COSINE SIMILARITY</div>
                <div class="result-name" id="matchName">---</div>
                <div class="result-score" id="matchScore">ç›¸ä¼¼åº¦: 0%</div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-load" id="btnLoad" onclick="initAndLoadData()">
            <i class="fas fa-file-alt fa-lg"></i><br>1. è®€å–æ¸…å–®ä¸¦å•Ÿå‹•
        </button>
        <button class="btn btn-record" id="btnRecord" disabled onclick="startRecording()">
            <i class="fas fa-microphone-lines fa-lg"></i><br>2. éŒ„è£½æ¨£æœ¬
        </button>
        <button class="btn btn-stop" id="btnStop" disabled onclick="stopRecording()">
            <i class="fas fa-stop-circle fa-lg"></i><br>3. è²ç´‹æ¯”å°
        </button>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šå€
    // ==========================================
    
    // ğŸ‘‡ è«‹ç¢ºèªæ‚¨çš„è²éŸ³æª”å‰¯æª”å (ä¾‹å¦‚ .opus, .mp3, .wav)
    const AUDIO_EXT = '.opus'; 
    
    const IMAGE_EXT = '.png';
    const FFT_SIZE = 512; 
    
    // ==========================================
    // ğŸš€ æ ¸å¿ƒè®Šæ•¸
    // ==========================================

    let audioContext;
    let database = []; // {name, featureVector: Float32Array}
    let mediaRecorder;
    let audioChunks = [];
    let analyser;
    let dataArray;
    let animationId;
    
    const statusMsg = document.getElementById('statusMsg');
    const btnLoad = document.getElementById('btnLoad');
    const btnRecord = document.getElementById('btnRecord');
    const btnStop = document.getElementById('btnStop');
    const resultArea = document.getElementById('resultArea');
    const matchName = document.getElementById('matchName');
    const matchScore = document.getElementById('matchScore');
    const pokemonImg = document.getElementById('pokemonImg');
    const placeholderIcon = document.getElementById('placeholderIcon');
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');

    // --- 1. ç³»çµ±åˆå§‹åŒ–èˆ‡è³‡æ–™è¼‰å…¥ (æ”¯æ´ list.txt) ---
    async function initAndLoadData() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }

        btnLoad.disabled = true;
        btnLoad.innerHTML = '<i class="fas fa-spinner fa-spin"></i><br>è®€å– list.txt...';
        statusMsg.innerText = "æ­£åœ¨è®€å–æ¸…å–®...";
        
        database = [];
        let pokemonList = [];

        // æ­¥é©Ÿ A: è®€å– list.txt
        try {
            // åŠ ä¸€å€‹æ™‚é–“åƒæ•¸é¿å…ç€è¦½å™¨å¿«å–èˆŠçš„ list.txt
            const response = await fetch('list.txt?nocache=' + new Date().getTime());
            
            if (!response.ok) {
                throw new Error("æ‰¾ä¸åˆ° list.txtï¼Œè«‹ç¢ºèªæª”æ¡ˆä½ç½®ã€‚");
            }
            
            const textData = await response.text();
            
            // å°‡æ–‡å­—æª”ä¾æ›è¡Œç¬¦è™Ÿåˆ‡å‰²ï¼Œä¸¦éæ¿¾æ‰ç©ºç™½è¡Œ
            pokemonList = textData.split(/\r?\n/).filter(line => line.trim() !== "");
            
            if (pokemonList.length === 0) {
                throw new Error("list.txt å…§å®¹ç‚ºç©º");
            }

            statusMsg.innerText = `è®€å–åˆ° ${pokemonList.length} ç­†è³‡æ–™ï¼Œé–‹å§‹åˆ†æè²ç´‹...`;

        } catch (err) {
            alert("è®€å– list.txt å¤±æ•—ï¼\n1. è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨\n2. è«‹ç¢ºèªæª”æ¡ˆç·¨ç¢¼ç‚º UTF-8");
            statusMsg.innerText = "âŒ æ¸…å–®è®€å–å¤±æ•—";
            btnLoad.disabled = false;
            btnLoad.innerHTML = '<i class="fas fa-redo"></i><br>é‡è©¦';
            return;
        }

        // æ­¥é©Ÿ B: æ ¹æ“šæ¸…å–®ä¸‹è¼‰è²éŸ³ä¸¦åˆ†æ
        let successCount = 0;
        let failCount = 0;

        for (let name of pokemonList) {
            name = name.trim(); // å»é™¤å‰å¾Œç©ºç™½
            const audioPath = `wav/${name}${AUDIO_EXT}`;
            
            try {
                statusMsg.innerText = `åˆ†æä¸­: ${name}...`;
                const response = await fetch(audioPath);
                
                if (!response.ok) {
                    console.warn(`æ‰¾ä¸åˆ°è²éŸ³æª”: ${audioPath}`);
                    failCount++;
                    continue;
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const feature = await extractVoiceprint(audioBuffer);
                
                database.push({ name: name, feature: feature });
                successCount++;
                
            } catch (err) {
                console.error(`åˆ†æå¤±æ•—: ${name}`, err);
                failCount++;
            }
        }

        if (successCount === 0) {
            statusMsg.innerText = "âŒ æ‰€æœ‰è²éŸ³æª”çš†è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ wav è³‡æ–™å¤¾";
            btnLoad.disabled = false;
            btnLoad.innerHTML = '<i class="fas fa-redo"></i><br>é‡è©¦';
        } else {
            let msg = `âœ… ç³»çµ±å°±ç·’ (æˆåŠŸ: ${successCount})`;
            if(failCount > 0) msg += ` (å¤±æ•—: ${failCount})`;
            statusMsg.innerText = msg;
            
            btnLoad.style.display = 'none';
            btnRecord.disabled = false;
        }
    }

    // --- 2. è²ç´‹æå– (ä¸è®Š) ---
    async function extractVoiceprint(audioBuffer) {
        const offlineCtx = new OfflineAudioContext(1, audioBuffer.length, audioBuffer.sampleRate);
        const source = offlineCtx.createBufferSource();
        source.buffer = audioBuffer;

        const analyserNode = offlineCtx.createAnalyser();
        analyserNode.fftSize = FFT_SIZE;
        analyserNode.smoothingTimeConstant = 0.0;
        
        source.connect(analyserNode);
        analyserNode.connect(offlineCtx.destination);
        source.start(0);

        const renderQuantumInSeconds = 128 / audioBuffer.sampleRate;
        const duration = audioBuffer.duration;
        const steps = Math.floor(duration * 20); 
        const interval = duration / steps;

        let accumSpectrum = new Float32Array(analyserNode.frequencyBinCount).fill(0);
        let count = 0;

        for (let i = 0; i < steps; i++) {
            const time = i * interval;
            offlineCtx.suspend(time).then(() => {
                const tempArray = new Float32Array(analyserNode.frequencyBinCount);
                analyserNode.getFloatFrequencyData(tempArray);
                for (let j = 0; j < tempArray.length; j++) {
                    const db = tempArray[j];
                    if (db > -100) {
                        accumSpectrum[j] += (db + 100); 
                    }
                }
                count++;
            }).then(() => offlineCtx.resume());
        }

        await offlineCtx.startRendering();

        for (let j = 0; j < accumSpectrum.length; j++) {
            if(count > 0) accumSpectrum[j] /= count;
        }
        return normalizeVector(accumSpectrum);
    }

    // --- 3. æ•¸å­¸å·¥å…· (ä¸è®Š) ---
    function normalizeVector(vector) {
        let sumSq = 0;
        for (let i = 0; i < vector.length; i++) {
            sumSq += vector[i] * vector[i];
        }
        const magnitude = Math.sqrt(sumSq);
        const normalized = new Float32Array(vector.length);
        if (magnitude > 0) {
            for (let i = 0; i < vector.length; i++) {
                normalized[i] = vector[i] / magnitude;
            }
        }
        return normalized;
    }

    function cosineSimilarity(vecA, vecB) {
        let dotProduct = 0;
        const len = Math.min(vecA.length, vecB.length);
        for (let i = 0; i < len; i++) {
            dotProduct += vecA[i] * vecB[i];
        }
        return dotProduct;
    }

    // --- 4. éŒ„éŸ³åŠŸèƒ½ (ä¸è®Š) ---
    async function startRecording() {
        resultArea.style.visibility = 'hidden';
        pokemonImg.style.display = 'none';
        placeholderIcon.style.display = 'block';
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = FFT_SIZE;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animationId);
                stream.getTracks().forEach(track => track.stop());
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // æ‰‹æ©ŸéŒ„éŸ³é€šå¸¸æ˜¯ webm
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                analyzeRecording(audioBuffer);
            };

            mediaRecorder.start();
            statusMsg.innerText = "ğŸ¤ æ¡æ¨£ä¸­...";
            btnRecord.disabled = true;
            btnStop.disabled = false;

        } catch (err) {
            alert("éº¥å…‹é¢¨å­˜å–å¤±æ•— (éœ€ HTTPS): " + err);
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            btnRecord.disabled = false;
            btnStop.disabled = true;
            statusMsg.innerText = "ğŸ§® é‹ç®—ä¸­...";
        }
    }

    // --- 5. æ¯”å°èˆ‡çµæœ (ä¸è®Š) ---
    async function analyzeRecording(recordedBuffer) {
        if (database.length === 0) return;

        const recordedFeature = await extractVoiceprint(recordedBuffer);
        
        let bestMatch = null;
        let highestScore = -1;

        for (let item of database) {
            const score = cosineSimilarity(recordedFeature, item.feature);
            if (score > highestScore) {
                highestScore = score;
                bestMatch = item.name;
            }
        }

        resultArea.style.visibility = 'visible';
        
        const THRESHOLD_MATCH = 0.85; 
        const THRESHOLD_GUESS = 0.60;

        if (highestScore > THRESHOLD_GUESS) {
            matchName.innerText = bestMatch;
            showPokemonImage(bestMatch);
            
            const percentage = (highestScore * 100).toFixed(1);
            matchScore.innerText = `ç›¸ä¼¼åº¦: ${percentage}%`;

            if (highestScore > THRESHOLD_MATCH) {
                matchName.style.color = "#0f0";
                statusMsg.innerText = `âœ… è²ç´‹å»åˆï¼æ˜¯ ${bestMatch}`;
            } else {
                matchName.style.color = "#ffeb3b";
                statusMsg.innerText = `âš ï¸ è²ç´‹ç›¸ä¼¼ï¼Œå¯èƒ½æ˜¯ ${bestMatch}`;
            }
        } else {
            matchName.innerText = "ç„¡åŒ¹é…å°è±¡";
            matchName.style.color = "#888";
            matchScore.innerText = `æœ€é«˜ç›¸ä¼¼åº¦: ${(highestScore * 100).toFixed(1)}%`;
            statusMsg.innerText = "âŒ æœªåµæ¸¬åˆ°å·²çŸ¥é »è­œ";
            pokemonImg.style.display = 'none';
            placeholderIcon.style.display = 'block';
        }
    }

    function showPokemonImage(name) {
        // åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å…åœ–ç‰‡å¿«å–å•é¡Œ (é¸æ“‡æ€§)
        const imgPath = `pic/${name}${IMAGE_EXT}`;
        pokemonImg.src = imgPath;
        pokemonImg.onload = () => {
            placeholderIcon.style.display = 'none';
            pokemonImg.style.display = 'block';
        };
        pokemonImg.onerror = () => {
            placeholderIcon.style.display = 'block';
            pokemonImg.style.display = 'none';
        };
    }

    // --- 6. è¦–è¦ºåŒ– (ä¸è®Š) ---
    function drawVisualizer() {
        animationId = requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);

        canvasCtx.fillStyle = '#000';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / dataArray.length) * 2.5;
        let x = 0;

        for(let i = 0; i < dataArray.length; i++) {
            const barHeight = (dataArray[i] / 255) * canvas.height;
            canvasCtx.fillStyle = `rgb(0, ${dataArray[i] + 50}, 0)`;
            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
</script>

</body>
</html>